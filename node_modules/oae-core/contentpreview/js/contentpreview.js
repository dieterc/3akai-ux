/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core', '/node_modules/oae-core/contentpreview/lib/document-viewer/assets/viewer.js'], function($, oae, DV) {

    return function(uid, showSettings, widgetData) {

        // Cache the widget container
        var $rootel = $('#' + uid);

        var white_list = {
            'blip': RegExp('blip\\.tv/.+'),
            'cacoo': RegExp('cacoo.com/.+'),
            'dailymotion': RegExp('dailymotion\\.com/.+'),
            'deviantart': RegExp('deviantart.com/.+'),
            'dribble': RegExp('dribbble.com/shots/.+'),
            'facebook': RegExp('facebook.com/(people/[^\\/]+/\\d+|[^\\/]+$)'),
            /*'fixit': RegExp(''),*/
            'flickr': RegExp('flickr\\.com/photos/.+'),
            'githubgist': RegExp('gist.github.com/+'),
            'github': RegExp('github.com/[-.\\w@]+/[-.\\w@]+'),
            'googlecalendar': RegExp('www.google.com/calendar/embed?.+'),
            'hulu': RegExp('hulu\\.com/watch/.*'),
            'imgly': RegExp('img\\.ly/.+'),
            'imgurcom': RegExp('imgur\\.com/gallery/.+'),
            'instagram': RegExp('instagr\\.?am(\\.com)?/.+'),
            'jsfiddle': RegExp('jsfiddle.net/[^/]+/?'),
            /*'lastfm': RegExp(''),*/
            'linkedin': RegExp('linkedin.com/in/.+'),
            /*'livestream': RegExp(''),*/
            'pastebin': RegExp('pastebin\\.com/[\\S]{8}'),
            'pastie': RegExp('pastie\\.org/pastes/.+'),
            'photobucket': RegExp('photobucket\\.com/(albums|groups)/.+'),
            /*'pintrest': RegExp(''),*/
            'prezi': RegExp('prezi.com/.*'),
            /*'rottentomatoes': RegExp(''),*/
            'scribd': RegExp('scribd\\.com/.+'),
            'slideshare': RegExp('slideshare\.net'),
            'soundcloud': RegExp('soundcloud.com/.+'),
            'soundcloud_short': RegExp('snd.sc/.+'),
            'speakerdeck': RegExp('speakerdeck.com/.+'),
            'spotify': RegExp('(play|open).spotify.com/(album|track)'),
            'stackoverflow': RegExp('stackoverflow.com/questions/[\\d]+'),
            'ted': RegExp('ted.com/talks/.+'),
            /*'tinychat': RegExp(''),*/
            /*'tumblr': RegExp(''),*/
            'twitgoocom': RegExp('twitgoo\\.com/.+'),
            'twitpic': RegExp('twitpic.com/.+'),
            'twitter': RegExp('twitter.com/.+'),
            'twitvid': RegExp('twitvid\\.com/.+'),
            'ustreamtv': RegExp('ustream\\.tv/+'), 
            'viddler': RegExp('viddler.com/v/.+'),
            'vimeo': RegExp('vimeo\.com/.+'),
            'visually': RegExp('visual\\.ly/.+'),
            /*'wikipedia': RegExp('wikipedia.org/wiki/.+'),*/
            'wordpress': RegExp('wordpress\\.com/.+'),
            'yfrog': RegExp('yfrog\\.(com|ru|com\\.tr|it|fr|co\\.il|co\\.uk|com\\.pl|pl|eu|us)/.+'),
            'youtube': RegExp('youtube\\.com/watch.+v=[\\w-]+&?')
        };

        /**
         * Render an image preview by embedding the image into the document
         */
        var renderImagePreview = function() {
            oae.api.util.template().render($('#contentpreview_image_template', $rootel), widgetData, $('#contentpreview_preview', $rootel));
        };

        var renderOembed = function(maxWidth, maxHeight, includeHandle) {
            $('#contentpreview_oembed_template').oembed(widgetData.link, {maxWidth: maxWidth, maxHeight: maxHeight, includeHandle: includeHandle});
            oae.api.util.template().render($('#contentpreview_oembed_template', $rootel), widgetData, $('#contentpreview_preview', $rootel));
        };

        var renderEmbedly = function() {
            oae.api.util.template().render($('#contentpreview_oembed_template', $rootel), widgetData, $('#contentpreview_preview', $rootel));
            $('#contentpreview_preview a').embedly({key: '02f6679e52374bb5a307f1172a38f6e4'});
        };

        /**
         * Render a link's preview in an iFrame
         */
        var renderLinkPreview = function() {
            oae.api.util.template().render($('#contentpreview_html_template', $rootel), widgetData, $('#contentpreview_preview', $rootel));
        };

        /**
         * Render a PDF or Office Document
         */
        var renderDocumentPreview = function() {
            var doc = {
                'id': widgetData.id,
                'title': widgetData.displayName,
                'pages': widgetData.previews.pageCount,
                'resources': {
                    'pdf': '/api/content/' + widgetData.id + '/download',
                    'page': {
                        'image': '/api/content/' + widgetData.id + '/previews/page.{page}.{size}.png?signature=' + widgetData.signature.signature + '&expires=' + widgetData.signature.expires + '&lastmodified=' + widgetData.signature.lastModified
                    }
                }
            };
            DV.load(doc, {
                'container': '#' + uid + ' #contentpreview_preview',
                'width': '100%',
                'height': 700,
                'sidebar': false,
                'text': false
            });
        };

        /**
         * Render the default preview for all files that don't have a particular in-line preview
         */
        var renderDefault = function() {
            oae.api.util.template().render($('#contentpreview_default_template', $rootel), widgetData, $('#contentpreview_preview', $rootel));
        };

        /**
         * Decide what type of preview to render based on the content type, mimetype and previews data
         */
        var initPreview = function() {
            // Links
            if (widgetData.resourceSubType === 'link') {
                switch (true) {
                    case white_list.blip.test(widgetData.link):
                        console.log('Blip'); // Werkt 2 random links getest
                        renderOembed(700,null,false);
                        break;
                    case white_list.cacoo.test(widgetData.link):
                        console.log('Cacoo'); // Werkt niet 404 (Not Found) !
                        //renderOembed();
                        //renderEmbedly();
                        break;
                    case white_list.dailymotion.test(widgetData.link):
                        console.log('Dailymotion'); // Werkt 3 links getest
                        renderOembed(700,null,false);
                        break;
                    case white_list.deviantart.test(widgetData.link):
                        console.log('Deviantart'); // Werkt 2 links getest maar breedten hoogte werkt niet
                        renderOembed(100,350,false);
                        break;
                    case white_list.dribble.test(widgetData.link):
                        console.log('Dribbble'); //  Werkt maar niet volledig, kleine foto 2 links getest
                        renderOembed(350,350,false);
                        break;
                    case white_list.facebook.test(widgetData.link):
                        console.log('Facebook');    // Enkel profiel foto, naam en geslacht ??
                        renderOembed(null, null, false);
                        break;
                    /*case white_list.fixit.test(widgetData.link):
                        console.log('Fixit');
                        renderOembed();
                        break;*/
                    case white_list.flickr.test(widgetData.link):
                        console.log('Flickr');
                        //renderEmbedly();
                        $.ajax({
                            url: 'http://noembed.com/embed?url=' + widgetData.link,
                            dataType: 'json',
                            success: function(result) {
                                console.log(result);
                                switch(result.type) {
                                    case 'photo':
                                        if(result.media_url) {
                                            $('#contentpreview_preview').append('<img src=' + result.media_url +' alt=' + result.title + ' />');  
                                        } else {
                                            var newURL = result.thumbnail_url.replace('_s','_b');
                                           $('#contentpreview_preview').append('<img src=' + newURL +' alt=' + result.title + ' />');  

                                        }
                                        break;
                                    case 'video':
                                        $('#contentpreview_preview').append(result.html);
                                        break;
                                }
                            }   
                        });
                        break;
                    case white_list.github.test(widgetData.link):
                        console.log('Github');  // Werkt maar geen nuttige info? geen profiel links
                        //renderOembed(null, null, false);
                        break;
                    case white_list.githubgist.test(widgetData.link):
                        console.log('Github gist'); // Werkt niet
                        renderOembed();
                        break;
                    case white_list.googlecalendar.test(widgetData.link):
                        console.log('Google Calendar');
                        renderOembed();
                        break;
                    case white_list.hulu.test(widgetData.link):
                        console.log('Hulu');            // Werkt 2 links getest, wel veel problemen met regio
                        renderOembed(700,null,false);
                        break;
                    case white_list.imgly.test(widgetData.link):
                        console.log('Imgly');   // Werkt 2 links getest, kleine foto's, hoogte??
                        renderOembed(350,null,false);
                        break;
                    case white_list.imgurcom.test(widgetData.link):
                        console.log('Imgur.com');   // Werkt 2 links getest, kleine foto's, ???
                        renderOembed(350, null,false);
                        break;
                    case white_list.instagram.test(widgetData.link):
                        console.log('Instagram');   //Werkt 2 links getest
                        renderOembed(null,null,false);
                        break;
                    case white_list.jsfiddle.test(widgetData.link):
                        console.log('JSfiddle'); // Werkt niet, 404
                        renderOembed(null,null,false);
                        break;
                    /*case white_list.lastfm.test(widgetData.link):
                        console.log('Last.fm');
                        renderOembed();
                        break;*/
                    case white_list.linkedin.test(widgetData.link):
                        console.log('Linkedin'); // Werkt niet
                        //renderOembed();
                        renderEmbedly();
                        break;
                    /*case white_list.livestream.test(widgetData.link):
                        console.log('Livestream');
                        renderOembed();
                        break;*/
                    case white_list.pastebin.test(widgetData.link):
                        console.log('Pastebin'); // Werkt maar problemen met hoogte en breedte staat er niet volledig op, 2 links getest
                        renderOembed(null, null, false);
                        break;
                    case white_list.pastie.test(widgetData.link):
                        console.log('Pastie'); // Werkt maar styling niet ok? hoogte en breedte werkt niet, 2 links getest
                        renderOembed(350, 350, false);
                        break;
                    case white_list.photobucket.test(widgetData.link):
                        console.log('Photobucket'); // Werkt met direct link, hoogte en breedte werkt niet, 2 links getest
                        renderOembed(350, 350, false);
                        break;
                    /*case white_list.pintrest.test(widgetData.link):
                        console.log('Pintrest');
                        renderOembed();
                        break;*/
                    case white_list.prezi.test(widgetData.link):
                        console.log('Prezi'); // Werkt 2 links getest
                        renderOembed(700, null, false);
                        break;
                    /*case white_list.rottentomatoes.test(widgetData.link):
                        console.log('Rotten Tomatoes');
                        renderOembed();
                        break;*/
                    case white_list.scribd.test(widgetData.link):
                        console.log('Scribd'); // Werkt 2 links getest
                        renderOembed(null,null,false);
                        break;
                    case white_list.slideshare.test(widgetData.link):
                        console.log('Slideshare');  // Werkt 2 links getest
                        renderOembed(null,null,false);
                        break;
                    case white_list.soundcloud.test(widgetData.link):
                        console.log('Soundcloud'); // Werkt
                        renderOembed(null,null,false);
                        //renderEmbedly();
                        break;
                    case white_list.soundcloud_short.test(widgetData.link):
                        console.log('Soundcloud Short'); // Werkt 
                        renderOembed(null, null, false);
                        break;
                    case white_list.speakerdeck.test(widgetData.link):
                        console.log('Speakerdeck'); // Werkt 2 links getest
                        renderOembed(null,null,false);
                        break;
                    case white_list.spotify.test(widgetData.link):
                        console.log('Spotify');
                        widgetData.link = widgetData.link.replace("play","open");
                        //renderOembed();
                        //$.embedly.preview(widgetData.link,{key: '02f6679e52374bb5a307f1172a38f6e4'});
                        renderEmbedly();
                        break;
                    case white_list.stackoverflow.test(widgetData.link):
                        console.log('Stackoverflow'); // Werkt 2 links getest maar geen style? te weinig info?
                        renderOembed(null,null,false);
                        break;
                    case white_list.ted.test(widgetData.link):
                        console.log('TED');
                        //renderOembed();
                        $.ajax({
                            url: 'http://noembed.com/embed?url=' + widgetData.link,
                            dataType: 'json',
                            success: function(result) {
                                console.log(result);
                                $('#contentpreview_preview').append(result.html);
                            }   
                        });
                        break;
                    /*case white_list.tinychat.test(widgetData.link):
                        console.log('Tinychat');
                        renderOembed();
                        break;*/
                    /*case white_list.tumblr.test(widgetData.link):
                        console.log('Tumblr');
                        renderOembed();
                        break;*/
                    case white_list.twitgoocom.test(widgetData.link):
                        console.log('Twitgoo.com'); // Werkt maar de grote foto's klopt niet te klein 2 getest
                        renderOembed(700, null, false);
                        break;
                    case white_list.twitpic.test(widgetData.link):
                        console.log('Twitpic');
                        //renderOembed();
                        $.ajax({
                            url: 'http://noembed.com/embed?url=' + widgetData.link,
                            dataType: 'json',
                            success: function(result) {
                                console.log(result);
                                $('#contentpreview_preview').append(result.html);
                            }   
                        });
                        break;
                    case white_list.twitter.test(widgetData.link):
                        console.log('Twitter'); // Werkt maar enkel met tweets 2 getest en 1 profiel
                        renderOembed(null, null, false);
                        break;
                    /*case white_list.twitvid.test(widgetData.link):
                        console.log('Twitvid');
                        renderOembed();
                        break;*/
                    case white_list.ustreamtv.test(widgetData.link):
                        console.log('Ustream.tv');  // Livestream werkt maar foto + tekst ipv video
                        renderOembed();             // Recorded video werkt niet
                        break;
                    case white_list.viddler.test(widgetData.link):
                        console.log('Viddler');
                        renderOembed(null,null,false);
                        break;
                    case white_list.vimeo.test(widgetData.link):
                        console.log('Vimeo'); // Werkt 2 links getest
                        renderOembed(700, null, false);
                        break;
                    case white_list.visually.test(widgetData.link):
                        console.log('Visual.ly'); // Er wordt niets getoond 
                        renderOembed(700,null,false);
                        break;
                    /*case white_list.wikipedia.test(widgetData.link):
                        console.log('Wikipedia');
                        renderOembed();
                        break;*/
                    case white_list.wordpress.test(widgetData.link):
                        console.log('Wordpress');
                        renderOembed();
                        break;
                    case white_list.yfrog.test(widgetData.link):
                        console.log('Yfrog'); // Werkt maar styling aanpassen? 2 links getest
                        renderOembed(700,null,false);
                        break;
                    case white_list.youtube.test(widgetData.link):
                        console.log('Youtube');  //Werkt 2 links getest
                        renderOembed(700,null,false);
                        break;                        
                    default:
                        console.log('Another link');
                        renderLinkPreview();
                        break;
                }
            // Uploaded files
            } else if (widgetData.resourceSubType === 'file') {
                // Image preview
                if (widgetData.mime.substring(0, 6) === 'image/') {
                    renderImagePreview();
                // Display PDFs, Office files, ..
                } else if (widgetData.previews.hasOwnProperty('pageCount')) {
                    renderDocumentPreview();
                // Default preview
                } else {
                    renderDefault();
                }
            }
        };

        initPreview();
    };
});
